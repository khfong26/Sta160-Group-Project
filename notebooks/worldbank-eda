# EDA for World Bank Data

import pandas as pd
import os
import matplotlib.pyplot as plt
import seaborn as sns

# 1Ô∏è‚É£ Setup
path = "/Users/royho/Desktop/World Bank Data - Datasets V2"
os.chdir(path)

# 2Ô∏è‚É£ Load cleaned datasets (from your cleaned notebook)
files = {
    "cpi": "Consumer price index (2010 = 100).csv",
    "food": "Consumer Prices, Food Indices (2015 = 100).csv",
    "exchange": "Exchange Rates.csv",
    "gdp": "GDP (Current US$).csv",
    "inflation": "Inflation - Avg consumer prices index.csv",
    "population": "Population, total.csv"
}

dfs = {k: pd.read_csv(v) for k, v in files.items()}

# 3Ô∏è‚É£ Filter for North America
countries = ["United States", "Canada", "Mexico"]
for k, df in dfs.items():
    df = df[df["Country Name"].isin(countries)]
    dfs[k] = df.reset_index(drop=True)

# 4Ô∏è‚É£ Basic checks
for name, df in dfs.items():
    print(f"\n--- {name.upper()} ---")
    print(df.shape)
    print(df.columns[:8])
    print(df.isna().sum().sum(), "missing values")

# 5Ô∏è‚É£ Reshape each dataset to long format (Year‚ÄìValue)


def melt_df(df, value_name):
    long_df = df.melt(id_vars=["Country Name", "Country Code"],
                      var_name="Year", value_name=value_name)
    long_df["Year"] = long_df["Year"].astype(str).str.extract("(\d{4})")
    long_df = long_df.dropna(subset=[value_name])
    long_df = long_df[long_df["Year"].notna()]
    long_df["Year"] = long_df["Year"].astype(int)
    return long_df


for k, df in dfs.items():
    dfs[k] = melt_df(df, value_name=k)

# 6Ô∏è‚É£ Merge into one summary frame (for correlations/trends)
merged = dfs["cpi"]
for k in ["food", "exchange", "gdp", "inflation", "population"]:
    merged = merged.merge(
        dfs[k], on=["Country Name", "Country Code", "Year"], how="outer")

print("\n‚úÖ Merged dataset shape:", merged.shape)
merged.head()

# 7Ô∏è‚É£ Summary statistics
summary = merged.groupby("Country Name")[
    ["cpi", "inflation", "exchange", "gdp", "population"]].describe().round(2)
display(summary)

# 8Ô∏è‚É£ Visualizations ‚Äî Trends by Country
sns.set_theme(style="whitegrid", palette="Set2")


def plot_trend(var, ylabel, title):
    plt.figure(figsize=(8, 5))
    sns.lineplot(data=merged, x="Year", y=var, hue="Country Name")
    plt.title(title, fontsize=13)
    plt.ylabel(ylabel)
    plt.xlabel("Year")
    plt.legend(title="Country")
    plt.show()


plot_trend("cpi", "CPI (2010=100)", "Consumer Price Index Trends")
plot_trend("inflation", "Inflation Rate (%)", "Inflation Trends")
plot_trend("exchange", "Exchange Rate (per USD)", "Exchange Rate Trends")
plot_trend("gdp", "GDP (Current US$)", "GDP Growth Over Time")
plot_trend("population", "Population (Total)", "Population Growth")

# 9Ô∏è‚É£ Correlation heatmap (macro indicators)
plt.figure(figsize=(7, 5))
corr = merged[["cpi", "inflation", "exchange", "gdp", "population"]].corr()
sns.heatmap(corr, annot=True, cmap="coolwarm", fmt=".2f")
plt.title("Correlation Between World Bank Indicators (North America)")
plt.show()

# üîü Export cleaned + merged version for dashboard use
out_path = "../../data/world_bank/merged/world_bank_merged.csv"
os.makedirs(os.path.dirname(out_path), exist_ok=True)
merged.to_csv(out_path, index=False)
print("‚úÖ Saved:", out_path)
